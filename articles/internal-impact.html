<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using vimpact for estimating vaccine impact - internal • vimpact</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using vimpact for estimating vaccine impact - internal">
<meta property="og:description" content="vimpact">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vimpact</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/internal-impact.html">Using vimpact for estimating vaccine impact - internal</a>
    </li>
    <li>
      <a href="../articles/using-vimpact.html">Using vimpact for estimating vaccine impact</a>
    </li>
    <li>
      <a href="../articles/vignette.html">Using vimpact for estimating vaccine impact - VIMC members</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="internal-impact_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using vimpact for estimating vaccine impact - internal</h1>
                        <h4 class="author">Rob Ashton</h4>
            
            <h4 class="date">2021-10-12</h4>
      
      
      <div class="hidden name"><code>internal-impact.Rmd</code></div>

    </div>

    
    
<!-- DO NOT EDIT THIS FILE - see vignettes_src and make changes there -->
<p>This vignette describes how to use vimpact to calculate impact as a member of VIMC. This requires a connection to the montagu database so can only be used internally. Note that this is all in development and the interface is likely to change.</p>
<div id="impact-by-calendar-year-impact-by-birth-year" class="section level2">
<h2 class="hasAnchor">
<a href="#impact-by-calendar-year-impact-by-birth-year" class="anchor"></a>Impact by calendar year &amp; impact by birth year</h2>
<div id="function-interface" class="section level3">
<h3 class="hasAnchor">
<a href="#function-interface" class="anchor"></a>Function interface</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">impact</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">::</span><span class="fu"><a href="../reference/calculate_impact.html">calculate_impact</a></span><span class="op">(</span>
  <span class="va">con</span>, method <span class="op">=</span> <span class="st">"calendar_year"</span>, touchstone <span class="op">=</span> <span class="st">"201910gavi-5"</span>,
  modelling_group <span class="op">=</span> <span class="st">"CDA-Razavi"</span>,  disease <span class="op">=</span> <span class="st">"HepB"</span>,
  focal_scenario_type <span class="op">=</span> <span class="st">"default"</span>, focal_vaccine_delivery <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>vaccine <span class="op">=</span> <span class="st">"HepB_BD"</span>, activity_type <span class="op">=</span> <span class="st">"routine"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>vaccine <span class="op">=</span> <span class="st">"HepB"</span>, activity_type <span class="op">=</span> <span class="st">"routine"</span><span class="op">)</span>
  <span class="op">)</span>,
  baseline_scenario_type <span class="op">=</span> <span class="st">"novac"</span>,
  burden_outcomes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hepb_deaths_acute"</span>, <span class="st">"hepb_deaths_dec_cirrh"</span>,
                      <span class="st">"hepb_deaths_hcc"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">impact</span><span class="op">)</span>
<span class="co">#&gt; tibble [9,898 × 4] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ country       : chr [1:9898] "AFG" "AFG" "AFG" "AFG" ...</span>
<span class="co">#&gt;  $ burden_outcome: chr [1:9898] "deaths" "deaths" "deaths" "deaths" ...</span>
<span class="co">#&gt;  $ year          : int [1:9898] 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 ...</span>
<span class="co">#&gt;  $ impact        : num [1:9898] 0 0 0 0 0 0 0 53 81 97 ...</span></code></pre></div>
<p>Or for impact by birth year, use <code>method = "birth_year"</code>. This will get <code>burden_estimate_set</code> ids for the baseline and focal scenarios for this particular touchstone, modelling group, disease. Then uses those to pull the <code>burden_estimate</code> data for specified <code>burden_outcomes</code>. Optionally filtering on country via <code>countries</code> arg, year via <code>vaccination_years</code> and under 5 age groups if <code>is_under5 = TRUE</code>. We then use raw impact from <code>burden_estimate</code> table and call relevant public facing impact method. For <code>method = "calendar_year"</code> <code>impact_by_calendar_year</code>. For <code>method = "birth_year"</code> <code>impact_by_birth_year</code>.</p>
</div>
<div id="recipe-interface" class="section level3">
<h3 class="hasAnchor">
<a href="#recipe-interface" class="anchor"></a>Recipe interface</h3>
<p>Define a recipe either as a csv or using <code>recipe_template</code></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  touchstone <span class="op">=</span> <span class="st">"201910gavi-5"</span>,
  modelling_group <span class="op">=</span> <span class="st">"CDA-Razavi"</span>, disease <span class="op">=</span> <span class="st">"HepB"</span>,
  focal <span class="op">=</span> <span class="st">"default:HepB_BD-routine;HepB-routine"</span>,
  baseline <span class="op">=</span> <span class="st">"novac"</span>,
  burden_outcome <span class="op">=</span> <span class="st">"hepb_deaths_acute,hepb_deaths_dec_cirrh,hepb_deaths_hcc;hepb_cases_acute_severe,hepb_cases_dec_cirrh,hepb_cases_hcc"</span><span class="op">)</span>
<span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".csv"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">recipe</span>, <span class="va">t</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>This is a set of properties defining what data we want to extract from the db e.g. <code>touchstone</code>, <code>modelling_group</code>, <code>disease</code>, focal and baseline scenarios and <code>burden_outcome</code>. It captures the same info as the args to <code>calculate_impact</code> above. Then use the recipe to define meta data frame</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">:::</span><span class="fu">get_meta_from_recipe</span><span class="op">(</span>default_recipe <span class="op">=</span> <span class="cn">FALSE</span>, recipe <span class="op">=</span> <span class="va">t</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></code></pre></div>
<p>And use this to calculate impact</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">old_impact</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">:::</span><span class="fu">get_raw_impact_details</span><span class="op">(</span><span class="va">con</span>, <span class="va">meta</span>, <span class="st">"deaths"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">old_impact</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    9898 obs. of  7 variables:</span>
<span class="co">#&gt;  $ country       : int  104 104 104 104 104 104 104 104 104 104 ...</span>
<span class="co">#&gt;  $ time          : int  2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 ...</span>
<span class="co">#&gt;  $ baseline_value: num  5636 5765 5901 6034 6172 ...</span>
<span class="co">#&gt;  $ focal_value   : num  5636 5765 5901 6015 6075 ...</span>
<span class="co">#&gt;  $ value         : num  0 0 0 19 97 180 252 312 344 381 ...</span>
<span class="co">#&gt;  $ index         : int  1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;  $ burden_outcome: chr  "deaths" "deaths" "deaths" "deaths" ...</span></code></pre></div>
</div>
</div>
<div id="impact-by-year-of-vaccination" class="section level2">
<h2 class="hasAnchor">
<a href="#impact-by-year-of-vaccination" class="anchor"></a>Impact by year of vaccination</h2>
<div id="function-interface-1" class="section level3">
<h3 class="hasAnchor">
<a href="#function-interface-1" class="anchor"></a>Function interface</h3>
<p>Very similar to examples for calendar year and birth year, to calculate impact by year of vaccination stratified by activity type run</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">impact</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">::</span><span class="fu"><a href="../reference/calculate_impact.html">calculate_impact</a></span><span class="op">(</span>
  <span class="va">con</span>, method <span class="op">=</span> <span class="st">"yov_activity_type"</span>, touchstone <span class="op">=</span> <span class="st">"201910gavi-5"</span>,
  modelling_group <span class="op">=</span> <span class="st">"CDA-Razavi"</span>,  disease <span class="op">=</span> <span class="st">"HepB"</span>,
  focal_scenario_type <span class="op">=</span> <span class="st">"default"</span>, focal_vaccine_delivery <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>vaccine <span class="op">=</span> <span class="st">"HepB_BD"</span>, activity_type <span class="op">=</span> <span class="st">"routine"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>vaccine <span class="op">=</span> <span class="st">"HepB"</span>, activity_type <span class="op">=</span> <span class="st">"routine"</span><span class="op">)</span>
  <span class="op">)</span>,
  baseline_scenario_type <span class="op">=</span> <span class="st">"novac"</span>,
  burden_outcomes <span class="op">=</span> <span class="st">"dalys"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">impact</span><span class="op">)</span>
<span class="co">#&gt; tibble [4,432 × 6] (S3: tbl_df/tbl/data.frame)</span>
<span class="co">#&gt;  $ country       : chr [1:4432] "AFG" "AFG" "AFG" "AFG" ...</span>
<span class="co">#&gt;  $ vaccine       : chr [1:4432] "HepB" "HepB" "HepB" "HepB" ...</span>
<span class="co">#&gt;  $ activity_type : chr [1:4432] "routine" "routine" "routine" "routine" ...</span>
<span class="co">#&gt;  $ year          : int [1:4432] 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 ...</span>
<span class="co">#&gt;  $ burden_outcome: chr [1:4432] "dalys" "dalys" "dalys" "dalys" ...</span>
<span class="co">#&gt;  $ impact        : num [1:4432] 91667 94065 93427 98811 101646 ...</span></code></pre></div>
<p>or use <code>method = "yov_birth_cohort</code> for impact by year of vaccination stratified by birth cohort. This uses the same logic as other impact methods but before calling the public facing impact function it will also extract FVP data from the data base for this <code>touchstone</code> and vaccine delivery. It then calls either <code>impact_by_year_of_vaccination_activity_type</code> or <code>impact_by_year_of_vaccination_birth_cohort</code> to get impact.</p>
</div>
<div id="recipe-interface-1" class="section level3">
<h3 class="hasAnchor">
<a href="#recipe-interface-1" class="anchor"></a>Recipe interface</h3>
<p>We can re-use the recipe from above and get meta table for this method</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">:::</span><span class="fu">get_meta_from_recipe</span><span class="op">(</span>default_recipe <span class="op">=</span> <span class="cn">FALSE</span>, recipe <span class="op">=</span> <span class="va">t</span>,
                                      method <span class="op">=</span> <span class="st">"method2a"</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></code></pre></div>
<p>Then use this to get raw impact</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">old_raw_impact</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">:::</span><span class="fu">get_raw_impact_details</span><span class="op">(</span><span class="va">con</span>, <span class="va">meta</span>, <span class="st">"dalys"</span><span class="op">)</span></code></pre></div>
<p>Extract the fvp data and map output to required interface</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fvps</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_vaccination_history.html">extract_vaccination_history</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"201910gavi-5"</span>, year_min <span class="op">=</span> <span class="fl">2000</span>,
                                             year_max <span class="op">=</span> <span class="fl">2030</span>,
                                             disease_to_extract <span class="op">=</span> <span class="st">"HepB"</span><span class="op">)</span>
<span class="co">#&gt; User defined touchstone version is used.</span>
<span class="co">#&gt; Converting input coverage data......</span>
<span class="co">#&gt; Extracted interpolated population.</span>
<span class="co">#&gt; Extracted raw coverage data...</span>
<span class="co">#&gt; Transformed coverage data.</span>
<span class="va">fvps</span><span class="op">$</span><span class="va">fvps</span> <span class="op">&lt;-</span> <span class="va">fvps</span><span class="op">$</span><span class="va">fvps_adjusted</span>
<span class="va">fvps</span><span class="op">$</span><span class="va">country</span> <span class="op">&lt;-</span> <span class="va">fvps</span><span class="op">$</span><span class="va">country_nid</span></code></pre></div>
<p>Then can use <code>meta</code>, <code>raw_impact</code> and <code>fvps</code> to calculate impact by year of vaccination</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">old_impact</span> <span class="op">&lt;-</span> <span class="fu">vimpact</span><span class="fu">:::</span><span class="fu">impact_by_year_of_vaccination</span><span class="op">(</span>
  <span class="va">meta</span>, <span class="va">old_raw_impact</span>, <span class="va">fvps</span>, vaccination_years <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2030</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">old_impact</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    4964 obs. of  27 variables:</span>
<span class="co">#&gt;  $ country             : int  4 4 4 4 4 4 4 4 4 4 ...</span>
<span class="co">#&gt;  $ vaccine             : chr  "HepB_BD" "HepB_BD" "HepB_BD" "HepB" ...</span>
<span class="co">#&gt;  $ activity_type       : chr  "routine" "routine" "routine" "routine" ...</span>
<span class="co">#&gt;  $ scenario_description: chr  "best-estimates" "best-estimates" "best-estimates" "best-estimates" ...</span>
<span class="co">#&gt;  $ coverage_set        : int  1750 1750 1750 1751 1750 1750 1751 1751 1751 1751 ...</span>
<span class="co">#&gt;  $ delivery_id         : int  1174 1170 1172 2983 1183 1171 3997 2459 2982 3224 ...</span>
<span class="co">#&gt;  $ disease             : chr  "HepB" "HepB" "HepB" "HepB" ...</span>
<span class="co">#&gt;  $ scenario_type       : chr  "default" "default" "default" "default" ...</span>
<span class="co">#&gt;  $ gavi_support_level  : chr  "with" "with" "with" "with" ...</span>
<span class="co">#&gt;  $ year                : int  2028 2024 2025 2030 2018 2022 2023 2017 2027 2011 ...</span>
<span class="co">#&gt;  $ gavi_support        : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...</span>
<span class="co">#&gt;  $ gender              : chr  "Both" "Both" "Both" "Both" ...</span>
<span class="co">#&gt;  $ age                 : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;  $ target_source       : num  1185633 1179945 1180725 1188620 1145921 ...</span>
<span class="co">#&gt;  $ coverage_source     : num  0.621 0.423 0.473 0.749 0.18 ...</span>
<span class="co">#&gt;  $ cohort_size         : num  1185633 1179945 1180725 1188620 1145921 ...</span>
<span class="co">#&gt;  $ delivery_population : num  1185633 1179945 1180725 1188620 1145921 ...</span>
<span class="co">#&gt;  $ fvps_source         : num  736634 499471 558483 890514 206266 ...</span>
<span class="co">#&gt;  $ fvps_adjusted       : num  736634 499471 558483 890514 206266 ...</span>
<span class="co">#&gt;  $ coverage_adjusted   : num  0.621 0.423 0.473 0.749 0.18 ...</span>
<span class="co">#&gt;  $ country_nid         : int  4 4 4 4 4 4 4 4 4 4 ...</span>
<span class="co">#&gt;  $ fvps                : num  736634 499471 558483 890514 206266 ...</span>
<span class="co">#&gt;  $ time                : num  2028 2024 2025 2030 2018 ...</span>
<span class="co">#&gt;  $ burden_outcome      : chr  "dalys" "dalys" "dalys" "dalys" ...</span>
<span class="co">#&gt;  $ impact_ratio        : num  0.154 0.154 0.154 0.154 0.154 ...</span>
<span class="co">#&gt;  $ impact              : num  113108 76692 85754 136736 31672 ...</span>
<span class="co">#&gt;  $ index               : int  1 1 1 1 1 1 1 1 1 1 ...</span></code></pre></div>
</div>
</div>
<div id="comparison" class="section level2">
<h2 class="hasAnchor">
<a href="#comparison" class="anchor"></a>Comparison</h2>
<p><code>calculate_impact</code> has a very similar interface as a single row in an impact recipe. The output is slightly different format but output from previous method can be transformed into same format.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">country</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"country"</span><span class="op">)</span>
<span class="va">old_impact</span> <span class="op">&lt;-</span> <span class="va">old_impact</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">country</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"country"</span> <span class="op">=</span> <span class="st">"nid"</span><span class="op">)</span>, copy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>country <span class="op">=</span> <span class="va">id</span>, <span class="va">vaccine</span>, <span class="va">activity_type</span>, year <span class="op">=</span> <span class="va">time</span>,
                <span class="va">burden_outcome</span>, <span class="va">impact</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">impact</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">activity_type</span>, <span class="va">country</span>, <span class="va">year</span>, <span class="va">vaccine</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">old_impact</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    4279 obs. of  6 variables:</span>
<span class="co">#&gt;  $ country       : chr  "AFG" "AFG" "AFG" "AFG" ...</span>
<span class="co">#&gt;  $ vaccine       : chr  "HepB" "HepB" "HepB" "HepB" ...</span>
<span class="co">#&gt;  $ activity_type : chr  "routine" "routine" "routine" "routine" ...</span>
<span class="co">#&gt;  $ year          : num  2007 2008 2009 2010 2011 ...</span>
<span class="co">#&gt;  $ burden_outcome: chr  "dalys" "dalys" "dalys" "dalys" ...</span>
<span class="co">#&gt;  $ impact        : num  103859 106575 105852 111953 115165 ...</span></code></pre></div>
<p>and we can see from a plot that the output is very similar</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">impact_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">old_impact</span>, <span class="va">impact</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span>, all.y <span class="op">=</span> <span class="cn">TRUE</span>,
                     by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"vaccine"</span>, <span class="st">"activity_type"</span>, <span class="st">"year"</span>,
                            <span class="st">"burden_outcome"</span><span class="op">)</span><span class="op">)</span>
<span class="va">countries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">impact_plot</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>
<span class="va">impact_plot</span> <span class="op">&lt;-</span> <span class="va">impact_plot</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>recipe_impact <span class="op">=</span> <span class="va">impact.x</span>, function_impact <span class="op">=</span> <span class="va">impact.y</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">country</span>,
                     values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">recipe_impact</span>, <span class="va">function_impact</span><span class="op">)</span><span class="op">)</span>
<span class="va">impact_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">impact_plot</span><span class="op">)</span>
<span class="va">countries_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">button</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    method <span class="op">=</span> <span class="st">"restyle"</span>,
    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">impact_plot</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"recipe_impact_"</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">impact_plot</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"function_impact_"</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    label <span class="op">=</span> <span class="va">country</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu">plotly</span><span class="fu">::</span><span class="fu">plot_ly</span><span class="op">(</span>data <span class="op">=</span> <span class="va">impact_plot</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">plotly</span><span class="fu">::</span><span class="fu">add_trace</span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span><span class="va">year</span>, y <span class="op">=</span> <span class="op">~</span><span class="va">recipe_impact_AFG</span>, name <span class="op">=</span> <span class="st">"recipe"</span>,
                    type <span class="op">=</span> <span class="st">"scatter"</span>, mode <span class="op">=</span> <span class="st">"markers"</span>, text <span class="op">=</span> <span class="op">~</span><span class="va">vaccine</span>,
                    marker <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
                      color <span class="op">=</span> <span class="st">"rgb(235, 204, 42)"</span>,
                      size <span class="op">=</span> <span class="fl">10</span>
                    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">plotly</span><span class="fu">::</span><span class="fu">add_trace</span><span class="op">(</span>x <span class="op">=</span> <span class="op">~</span><span class="va">year</span>, y <span class="op">=</span> <span class="op">~</span><span class="va">function_impact_AFG</span>, name <span class="op">=</span> <span class="st">"function"</span>,
                    type <span class="op">=</span> <span class="st">"scatter"</span>, mode <span class="op">=</span> <span class="st">"markers"</span>, text <span class="op">=</span> <span class="op">~</span><span class="va">vaccine</span>,
                    marker <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
                      color <span class="op">=</span> <span class="st">"rgb(60, 154, 178)"</span>,
                      symbol <span class="op">=</span> <span class="st">"circle-open"</span>,
                      size <span class="op">=</span> <span class="fl">10</span>,
                      line <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
                        color <span class="op">=</span> <span class="st">"rgb(60, 154, 178)"</span>,
                        width <span class="op">=</span> <span class="fl">2</span>
                      <span class="op">)</span>
                    <span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">plotly</span><span class="fu">::</span><span class="fu">layout</span><span class="op">(</span>
    yaxis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"impact"</span><span class="op">)</span>,
    updatemenus <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
        y <span class="op">=</span> <span class="fl">0.7</span>,
        buttons <span class="op">=</span> <span class="va">countries_filter</span>
      <span class="op">)</span>
    <span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">htmltools</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/htmltools/man/builder.html">tags</a></span><span class="op">$</span><span class="fu">iframe</span><span class="op">(</span> 
  src <span class="op">=</span> <span class="st">"impact_comparisons.html"</span>, 
  width <span class="op">=</span> <span class="st">"100%"</span>, 
  height <span class="op">=</span> <span class="st">"400"</span>, 
  scrolling <span class="op">=</span> <span class="st">"no"</span>, 
  seamless <span class="op">=</span> <span class="st">"seamless"</span>, 
  frameBorder <span class="op">=</span> <span class="st">"0"</span>, 
  `data-external` <span class="op">=</span> <span class="st">"1"</span> 
<span class="op">)</span></code></pre></div>
<p><iframe src="impact_comparisons.html" width="100%" height="400" scrolling="no" seamless="seamless" frameborder="0" data-external="1"></iframe></p>
<p>There are small differences in impact because of differences in precision. <code>calculate_impact</code> tries to do large parts of the aggregation on the database where <code>burden_estimate</code> values are stored as Postgres <code>real</code> type which has 4 bytes of storage size and 6 decimal digits of precision. Whereas if we pull this before aggregation the values are stored in R as doubles which are much higher precision leading to small differences when aggregated.</p>
<p><code>calculate_impact</code> at the moment won’t be able to generate impact for you for more than 1 set of scenario comparisons. Next steps will be to add a wrapper which can take some data like the impact recipe and call <code>calculate_imapct</code> for multiple scenarios.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
