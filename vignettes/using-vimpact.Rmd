---
title: "Using vimpact for estimating vaccine impact"
author: "Xiang Li"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using vimpact for estimating vaccine impact}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
default_reporter <- testthat::default_reporter()
options(testthat.default_reporter = "summary")
```

This vignette describes how to use impact calculation methods used in VIMC as an external user.

## Impact by calendar year (cross-sectional impact)

Impact by calendar year calculates impact accrused over all ages for a specific year. This calculates the difference in disease burden between baseline and focal scenarios for a given year.

This method is available via function `impact_by_calendar_year`. To you use it you need to provide 2 data frames. These contain baseline and focal impact for a particular vaccine in multiple countries over a range of years and ages.

These data frames must contain columns for country, burden_outcome (e.g. cases, deaths, DALYs), year, age and value. It will sum the values for each group of country, burden_outcome, year for baseline and focal and calculate the difference of these groups.

If the baseline and focal impact data contains groups which do not overlap then this will return impact only for groups contained in both datasets.

```{r}
impact_test_data_baseline <- data.frame(
  country = c(rep("ETH", 5), rep("PAK", 5)),
  year = rep(c(2001, 2002, 2001, 2002, 2003), 2),
  age = c(0, 0, 1, 1, 1),
  value = c(234, 456, 345, 234, 345, 934, 567, 876, 675, 456),
  burden_outcome = rep("deaths", 10)
)

impact_test_data_focal <- data.frame(
  country = c(rep("ETH", 5), rep("PAK", 5)),
  year = rep(c(2001, 2002, 2001, 2002, 2003), 2),
  age = c(0, 0, 1, 1, 1),
  value = c(90, 121, 134, 221, 134, 432, 534, 433, 342, 355),
  burden_outcome = rep("deaths", 10)
)

vimpact::impact_by_calendar_year(impact_test_data_baseline, impact_test_data_focal)
```

## Impact by birth year (lifetime impact)

The birth year method accounts for the long-term impact accrued over the lifetime of a particular birth cohort. This method is available via function `impact_by_birth_year`. This requires the same data as `impact_by_calendar_year`. You need to provide 2 data frames. These contain baseline and focal impact for a particular vaccine in multiple countries over a range of years and ages.

These data frames must contain columns for country, burden_outcome (e.g. cases, deaths, DALYs), year, age and value. It will sum the impact grouped by country, burden_outcome, and birth year. Where birth year is `year - age`. Then calculates the impact for these groups.

If the baseline and focal impact data contains groups which do not overlap then this will return impact only for groups contained in both datasets.

```{r}
vimpact::impact_by_birth_year(impact_test_data_baseline, impact_test_data_focal)
```

## Impact by year of vaccination

Impact by year of vaccination methods are vital for determining the long-term impact of of vaccination due to activities carried out in a particular year. We obtain the impact ratio as the impact attributable per fully vaccinated person (FVP) calculated as the coverage Ã— cohort size. This ratio can be stratified by different characteristics, such as birth cohort in order to catch temporal changes in transmission or healthcare or by activity type to capture the differing effects of routine and campaign vaccination. The impact ratio allows effects due to a particular yearâ€™s worth of vaccination to be attributed to that year.

### Impact by year of vaccination: impact ratio stratified by activity type

To calculate impact by year of vaccination with impact ratio stratified by activity type use function `impact_by_year_of_vaccination_activity_type`. You need to provide 3 data frames. Like the previous two impact methods this needs a data frame of baseline impact and focal impact. These must contain the same columns as in the previous two methods with the addition of a column for the `activity_type` of the vaccination - either routine or campaign.

You also need to provide a data frame of FVP (fully vaccinated person) data which contains country, year, activity type, age and fvp. And a set of `vaccintaion_years` which is a range of years for which you want calculate impact for. This will be used to filter the baseline impact, focal impact and FVPs.

This method produces impact values for a particular disease stratified by country, activity type, year and burden outcome.

```{r}
impact_test_data_baseline$activity_type <- rep(c(rep("routine", 2), rep("campaign", 3)), 2)
impact_test_data_focal$activity_type <- rep(c(rep("routine", 2), rep("campaign", 3)), 2)
  
  
fvp_test_data <- data.frame(
  activity_type = c(rep("routine", 10), rep("campaign", 5)),
  country = c(rep("ETH", 5), rep("PAK", 10)),
  year = rep(2001:2005, 3),
  age = rep(0, 15),
  fvps = c(34, 54, 34, 54, 23, 65, 78, 98, 78, 98, 43, 45, 65, 45, 65)
)

vimpact::impact_by_year_of_vaccination_activity_type(impact_test_data_baseline, impact_test_data_focal, fvp_test_data, 2000:2030)
```

### Impact by year of vaccination: impact ratio stratified by birth cohort

